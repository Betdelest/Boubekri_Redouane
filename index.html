<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BETL — Visualisateur AR</title>

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    :root{
      --accent:#0a84ff;
      --muted:#999;
      --bg:#000;
      --card:#111;
      --white:#fff;
      --glass: rgba(255,255,255,0.06);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:Inter,Arial,Helvetica,sans-serif;-webkit-font-smoothing:antialiased}
    /* Top menu */
    .top-menu{position:absolute;top:12px;left:0;width:100%;padding:0 12px;display:flex;justify-content:space-between;align-items:center;z-index:40;box-sizing:border-box}
    .left-buttons{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:var(--glass);color:var(--white);font-size:14px;cursor:pointer;backdrop-filter: blur(4px)}
    .btn.primary{background:var(--white);color:#000}
    .btn.icon{display:inline-flex;gap:8px;align-items:center}
    .btn.small{padding:8px 10px;font-size:13px}
    .logo-link { display:flex; align-items:center; gap:10px; margin-right:8px; text-decoration:none; color:inherit; }
    .logo-small{height:44px;width:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    @media (max-width:480px){
      .btn{padding:8px 10px;font-size:13px;border-radius:8px}
      .logo-small{height:36px}
    }

    /* model-viewer fullscreen */
    model-viewer{width:100vw;height:100vh;display:block}

    /* AR button - always on top, bottom center */
    .ar-button{
      position:absolute;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      padding:14px 22px;
      background:#ffffff;
      color:#000;
      border:none;
      border-radius:12px;
      font-size:16px;
      font-weight:600;
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
      z-index:9999;
      cursor:pointer;
      display:block;
    }

    /* Progress bar */
    .progress-wrap{position:absolute;left:50%;transform:translateX(-50%);bottom:86px;z-index:30;display:flex;align-items:center;gap:12px;pointer-events:none}
    .progress{width:240px;height:10px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden}
    .progress > span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#4bd3ff);transition:width 200ms ease}
    .progress-label{color:var(--muted);font-size:13px;pointer-events:auto}

    /* Modal / Plans */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:80}
    .modal{width:min(760px,96%);max-height:86vh;background:var(--card);border-radius:12px;padding:16px;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,0.7)}
    .filters{display:flex;gap:10px;margin:8px 0 12px 0;flex-wrap:wrap}
    .filter-btn{padding:8px 12px;border-radius:10px;border:0;background:#222;color:#fff;cursor:pointer}
    .filter-btn.active{background:var(--accent)}
    .plan-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:8px}
    .plan-meta strong{display:block}
    .plan-actions button{margin-left:8px;padding:8px 10px;border-radius:8px;border:0;background:var(--white);color:#000;cursor:pointer}

    /* Preview */
    .preview-iframe{width:90vw;height:78vh;border:0;border-radius:8px;background:#fff}
    .preview-modal .modal{padding:10px}

    /* Splash */
    .splash{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:200;transition:opacity .4s ease, transform .4s ease}
    .splash.hidden{opacity:0;pointer-events:none;transform:scale(.98)}
    .splash-logo{width:260px;max-width:60vw;height:auto;display:block;filter:drop-shadow(0 10px 30px rgba(0,0,0,0.6))}
    .splash-sub{margin-top:12px;color:var(--muted);font-size:14px}
    .splash-percent{margin-top:8px;color:var(--muted);font-size:13px}
    @keyframes pulse {0%{transform:scale(0.98);opacity:0.9}50%{transform:scale(1);opacity:1}100%{transform:scale(0.98);opacity:0.9}}
    .splash-logo{animation:pulse 2.6s infinite ease-in-out}

    /* utilities */
    .hidden{display:none}
    a.no-dec{color:inherit;text-decoration:none}
  </style>
</head>
<body>

  <!-- TOP MENU (logo top-left clickable to Facebook) -->
  <div class="top-menu">
    <div class="left-buttons">
      <a class="logo-link" href="https://www.facebook.com/BETL121" target="_blank" title="Notre page Facebook (clic)">
        <img src="BETL.png" alt="BETL" class="logo-small" />
      </a>

      <button class="btn" onclick="changeModel('Villa_AR.glb')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;margin-right:6px"><path d="M12 3l9 6v9a1 1 0 0 1-1 1h-4v-6H8v6H4a1 1 0 0 1-1-1V9l9-6z" stroke="#fff" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Architecture
      </button>

      <button class="btn" onclick="changeModel('Villa_GC.glb')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle;margin-right:6px"><path d="M3 21h18" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/><path d="M6 3v18" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/><path d="M18 3v18" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>
        Génie Civil
      </button>
    </div>

    <div style="display:flex;align-items:center;gap:10px">
      <button class="btn primary icon" onclick="openPlans()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle"><path d="M21 15v4a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-4" stroke="#000" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 10l5 5 5-5" stroke="#000" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Télécharger PDF
      </button>
    </div>
  </div>

  <!-- MODEL VIEWER -->
  <model-viewer id="viewer"
    src="Villa_AR.glb"
    alt="Modèle 3D BETL"
    ar
    ar-modes="scene-viewer webxr"
    camera-controls
    environment-image="neutral"
    reveal="auto"
    exposure="1"
    shadow-intensity="1">
    <!-- AR button slot (we ensure it's always visible with script) -->
    <button slot="ar-button" class="ar-button" id="arBtn">Voir en Réalité Augmentée</button>
  </model-viewer>

  <!-- Progress indicator -->
  <div class="progress-wrap" aria-hidden="true">
    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
      <span id="progressBar"></span>
    </div>
    <div class="progress-label" id="progressLabel">Chargement 0%</div>
  </div>

  <!-- Modal: Plans list -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="if(event.target===this) closePlans()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="plansTitle">
      <h3 id="plansTitle">Plans à télécharger</h3>
      <p style="color:var(--muted); margin-top:6px">Filtrez par catégorie, prévisualisez un plan avant de le télécharger.</p>

      <div class="filters" id="filters">
        <button class="filter-btn active" data-cat="all" onclick="applyFilter('all')">Tous</button>
        <button class="filter-btn" data-cat="Architecture" onclick="applyFilter('Architecture')">Architecture</button>
        <button class="filter-btn" data-cat="GC" onclick="applyFilter('GC')">Génie Civil</button>
        <button class="filter-btn" data-cat="Autre" onclick="applyFilter('Autre')">Autres</button>
      </div>

      <div id="plansList" aria-live="polite"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn small" onclick="closePlans()">Fermer</button>
        <button class="btn primary small" onclick="downloadSelected()">Télécharger sélection</button>
      </div>
    </div>
  </div>

  <!-- Preview modal -->
  <div id="previewBackdrop" class="modal-backdrop preview-modal" onclick="if(event.target===this) closePreview()">
    <div class="modal" style="width:min(95%,1100px);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong id="previewTitle"></strong>
        <div><button class="btn small" onclick="closePreview()">Fermer</button></div>
      </div>
      <iframe id="pdfPreviewIframe" class="preview-iframe" src=""></iframe>
    </div>
  </div>

  <!-- Splash screen -->
  <div id="splash" class="splash" role="status" aria-live="polite">
    <img src="BETL.png" alt="BETL" class="splash-logo" />
    <div class="splash-sub">Chargement du modèle…</div>
    <div class="splash-percent" id="splashPercent">0%</div>
  </div>

<script>
/* ============== CONFIG ================ */
const SPLASH_DURATION_MS = 3000; // ms
const PLANS = [
  { id: 'arch', name: 'Plan Architecture - Villa', file: 'villa_Boubekri_redouane.pdf', desc: 'Plans architecturaux (A3, coupes, façades)', category: 'Architecture' },
  { id: 'gc',   name: 'Plan Génie Civil - Villa', file: 'Plans_Villa_GC.pdf', desc: 'Fondations, ferraillage, notes de calcul', category: 'GC' },
];

/* ============== Splash logic ============== */
const splash = document.getElementById('splash');
const splashPercent = document.getElementById('splashPercent');
let splashShownAt = performance.now();
let modelLoadedPercent = 0;

function hideSplash(force=false) {
  const elapsed = performance.now() - splashShownAt;
  if (!force && elapsed < SPLASH_DURATION_MS) {
    setTimeout(() => hideSplash(true), SPLASH_DURATION_MS - elapsed + 50);
    return;
  }
  splash.classList.add('hidden');
  setTimeout(()=> { if (splash && splash.parentNode) splash.parentNode.removeChild(splash); }, 600);
}
function tryHideSplashIfReady() {
  if (modelLoadedPercent >= 80) hideSplash();
}

/* ============== model-viewer progress ============== */
const viewer = document.getElementById('viewer');
const progressBar = document.getElementById('progressBar');
const progressLabel = document.getElementById('progressLabel');

viewer.addEventListener('progress', (e) => {
  const pct = Math.floor((e.detail.totalProgress || 0) * 100);
  modelLoadedPercent = pct;
  progressBar.style.width = pct + '%';
  progressLabel.textContent = `Chargement ${pct}%`;
  if (splash && !splash.classList.contains('hidden')) splashPercent.textContent = pct + '%';

  if (pct >= 100) {
    progressLabel.textContent = 'Modèle chargé';
    setTimeout(()=> {
      progressBar.style.width = '100%';
      setTimeout(()=> { progressLabel.style.display = 'none'; document.querySelector('.progress').style.display='none'; }, 700);
    }, 200);
    hideSplash();
  } else {
    progressLabel.style.display = 'block';
    document.querySelector('.progress').style.display = 'block';
  }
});

viewer.addEventListener('load', () => {
  // ensure AR button visible after successful load
  const arBtn = document.getElementById('arBtn');
  if (arBtn) arBtn.style.display = 'block';
});

viewer.addEventListener('error', (e) => {
  console.error('model-viewer error', e);
  progressLabel.textContent = 'Erreur chargement modèle';
  setTimeout(()=> hideSplash(true), 1200);
});

/* Add ar-status listener to hide button if AR is not possible on device */
viewer.addEventListener('ar-status', (ev) => {
  const btn = document.getElementById('arBtn');
  if (!btn) return;
  // if status failed, hide; if ready, show
  if (ev.detail && ev.detail.status === 'failed') btn.style.display = 'none';
  else btn.style.display = 'block';
});

/* ============== Buttons & switching ============== */
function changeModel(path) {
  viewer.src = path;
  progressLabel.style.display = 'block';
  document.querySelector('.progress').style.display = 'block';
  progressBar.style.width = '4%';
  progressLabel.textContent = 'Chargement 0%';
  if (!document.body.contains(splash)) document.body.appendChild(splash);
  splash.classList.remove('hidden');
  splashShownAt = performance.now();
}

/* ============== Plans modal ============== */
const modalBackdrop = document.getElementById('modalBackdrop');
const plansList = document.getElementById('plansList');
const previewBackdrop = document.getElementById('previewBackdrop');
const pdfPreviewIframe = document.getElementById('pdfPreviewIframe');
const previewTitle = document.getElementById('previewTitle');

let currentFilter = 'all';
let selectedIds = new Set();

function openPlans() { renderPlans(); modalBackdrop.style.display = 'flex'; }
function closePlans() { modalBackdrop.style.display = 'none'; }
function applyFilter(cat){
  currentFilter = cat;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.cat === cat));
  renderPlans();
}

function renderPlans() {
  plansList.innerHTML = '';
  const visible = PLANS.filter(p => currentFilter === 'all' || p.category === currentFilter);
  if (visible.length === 0) { plansList.innerHTML = '<p style="color:var(--muted)">Aucun plan dans cette catégorie.</p>'; return; }
  visible.forEach(plan=>{
    const item = document.createElement('div'); item.className = 'plan-item';
    const left = document.createElement('div'); left.style.display='flex'; left.style.gap='12px'; left.style.alignItems='center';
    const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.checked = selectedIds.has(plan.id);
    checkbox.onchange = (e)=> { if (e.target.checked) selectedIds.add(plan.id); else selectedIds.delete(plan.id); renderPlans(); };
    const meta = document.createElement('div'); meta.className='plan-meta';
    meta.innerHTML = `<strong>${plan.name}</strong><small style="color:var(--muted)">${plan.desc || ''}</small>`;
    left.appendChild(checkbox); left.appendChild(meta);
    const actions = document.createElement('div'); actions.className='plan-actions';
    const viewBtn = document.createElement('button'); viewBtn.textContent='Voir'; viewBtn.onclick = ()=> previewPDF(plan);
    const dlBtn = document.createElement('button'); dlBtn.textContent='Télécharger'; dlBtn.onclick = ()=> downloadPDF(plan.file);
    actions.appendChild(viewBtn); actions.appendChild(dlBtn);
    item.appendChild(left); item.appendChild(actions);
    plansList.appendChild(item);
  });
}

/* Preview PDF */
function previewPDF(plan){
  const url = resolvePDF(plan.file);
  previewTitle.textContent = plan.name;
  pdfPreviewIframe.src = url;
  previewBackdrop.style.display = 'flex';
}
function closePreview(){ pdfPreviewIframe.src = ''; previewBackdrop.style.display = 'none'; }

/* Resolve & download PDF */
function resolvePDF(path) {
  if (!path) return '';
  if (/^https?:\/\//i.test(path)) return encodeURI(path);
  return encodeURI(path);
}

async function downloadPDF(path) {
  const final = resolvePDF(path);
  try {
    const resp = await fetch(final, { method:'GET', mode:'cors' });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const blob = await resp.blob();
    let filename = 'document.pdf';
    const cd = resp.headers.get('Content-Disposition');
    if (cd) {
      const m = /filename\*?=([^;]+)/i.exec(cd);
      if (m && m[1]) filename = m[1].replace(/['"]/g,'');
    } else {
      const parts = final.split('/'); filename = parts[parts.length-1] || filename;
    }
    filename = decodeURIComponent(filename).replace(/%20/g,'_');
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  } catch (err) {
    console.warn('downloadPDF fallback - reason:', err);
    window.open(final, '_blank');
  }
}

function downloadSelected() {
  if (selectedIds.size === 0) { alert('Aucun plan sélectionné.'); return; }
  const toDownload = PLANS.filter(p => selectedIds.has(p.id));
  const delay = 650;
  toDownload.forEach((p, idx) => setTimeout(()=> downloadPDF(p.file), idx * delay));
}

/* ============== Init ============== */
splashShownAt = performance.now();
setTimeout(()=> tryHideSplashIfReady(), 1000);
renderPlans();
</script>
</body>
</html>
