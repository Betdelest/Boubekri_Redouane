<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AR Switch Models + Loader</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <style>
    body { margin: 0; background: #000; font-family: Arial, Helvetica, sans-serif; }
    model-viewer { width: 100vw; height: 100vh; }

    .switch-buttons {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 2;
    }

    .switch-buttons button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      background-color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    .download-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      background-color: #fff;
      color: #000;
      font-size: 14px;
      cursor: pointer;
      z-index: 3;
    }

    .ar-button {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: #fff;
      border-radius: 6px;
      font-size: 16px;
      z-index: 1;
    }

    #loadingText, #successMessage {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 20px;
      border-radius: 10px;
      z-index: 2;
    }

    #loadingText { bottom: 120px; display: none; }
    #successMessage { bottom: 60px; color: #0f0; display: none; }

    .logo {
      position: absolute;
      top: 70px;
      left: 10px;
      width: 70px;
      z-index: 3;
      cursor: pointer;
    }

    /* Modal (liste de plans) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal {
      width: min(520px, 95%);
      max-height: 80vh;
      overflow: auto;
      background: #111;
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.7);
      color: #fff;
    }
    .modal h3 { margin: 0 0 8px 0; font-size:18px; }
    .modal p { margin: 0 0 12px 0; color: #ccc; font-size:13px; }
    .plan-item {
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:8px;
      border-radius:8px;
      background: rgba(255,255,255,0.02);
      margin-bottom:8px;
    }
    .plan-left { display:flex; gap:10px; align-items:center; }
    .plan-icon { width:44px; height:44px; background:#222; border-radius:6px; display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff }
    .plan-meta { font-size:14px; }
    .plan-meta small { display:block; color:#aaa; font-size:12px; }
    .plan-actions { display:flex; gap:8px; align-items:center; }
    .plan-actions button {
      padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-size:13px;
      background:#fff; color:#000;
    }
    .modal-footer { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
    .close-btn { background:#444; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .download-all { background:#0a84ff; color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; }

    @media (max-width:480px){
      .plan-meta { font-size:13px; }
      .plan-icon{ width:40px; height:40px; }
    }
  </style>
</head>
<body>

  <!-- Logo cliquable vers la page Facebook -->
  <a href="https://www.facebook.com/BETL121" target="_blank">
    <img src="BETL.png" alt="Logo Bureau" class="logo" />
  </a>

  <div class="switch-buttons">
    <button onclick="changeModel('Villa_AR.glb')">Architecture</button>
    <button onclick="changeModel('Villa_GC.glb')">G√©nie Civil</button>
  </div>

  <button class="download-btn" onclick="openPlans()">üìÑ T√©l√©charger PDF</button>

  <div id="loadingText">Chargement... 0%</div>
  <div id="successMessage">‚úÖ Mod√®le charg√© avec succ√®s</div>

  <model-viewer 
    id="modelViewer"
    src="Villa_AR.glb"
    ar
    ar-modes="scene-viewer webxr"
    camera-controls
    shadow-intensity="1"
    disable-zoom="false"
    scale="0.01 0.01 0.01"
    environment-image="neutral"
    alt="Mod√®le 3D AR"
    loading="eager"
    reveal="auto"
  >
    <button slot="ar-button" class="ar-button">Voir en R√©alit√© Augment√©e</button>
  </model-viewer>

  <!-- Modal liste plans -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="if(event.target===this) closePlans()">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="plansTitle">
      <h3 id="plansTitle">Plans √† t√©l√©charger</h3>
      <p>S√©lectionnez le plan que vous souhaitez ouvrir ou t√©l√©charger. Les fichiers peuvent √™tre h√©berg√©s localement ou sur GitHub Pages.</p>

      <div id="plansList">
        <!-- Items g√©n√©r√©s dynamiquement -->
      </div>

      <div class="modal-footer">
        <button class="close-btn" onclick="closePlans()">Fermer</button>
        <button class="download-all" onclick="downloadAll()">T√©l√©charger tout</button>
      </div>
    </div>
  </div>

  <script>
    const viewer = document.getElementById('modelViewer');
    const loadingText = document.getElementById('loadingText');
    const successMessage = document.getElementById('successMessage');

    function showSuccessMessage() {
      successMessage.style.display = 'block';
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 2000);
    }

    viewer.addEventListener('progress', (event) => {
      const progress = Math.floor(event.detail.totalProgress * 100);
      loadingText.textContent = `Chargement... ${progress}%`;
      loadingText.style.display = 'block';

      if (progress === 100) {
        setTimeout(() => {
          loadingText.style.display = 'none';
          showSuccessMessage();
        }, 500);
      }
    });

    function changeModel(path) {
      viewer.src = path;
      loadingText.textContent = 'Chargement... 0%';
      loadingText.style.display = 'block';
      successMessage.style.display = 'none';
    }

    /* =======================
       Liste des plans (modifiable)
       Met ici les PDFs ‚Äî si tu les h√©berges sur GitHub Pages, mets l'URL compl√®te
       NOTE: j'ai remplac√© le nom avec underscores pour √©viter probl√®mes d'espaces
    =========================*/
    const PLANS = [
      { id: 'arch', name: 'Plan Architecture - Villa', file: 'villa_Boubekri_redouane.pdf', desc: 'Plans architecturaux (A3, coupes, fa√ßades)' },
      { id: 'gc',   name: 'Plan G√©nie Civil - Villa', file: 'Plans_Villa_GC.pdf', desc: 'Fondations, ferraillage, notes de calcul' },
      // ajouter d'autres plans si besoin
    ];

    const modalBackdrop = document.getElementById('modalBackdrop');
    const plansList = document.getElementById('plansList');

    function openPlans() {
      renderPlans();
      modalBackdrop.style.display = 'flex';
    }

    function closePlans() {
      modalBackdrop.style.display = 'none';
    }

    function renderPlans() {
      plansList.innerHTML = '';
      PLANS.forEach(plan=>{
        const item = document.createElement('div');
        item.className = 'plan-item';

        const left = document.createElement('div');
        left.className = 'plan-left';
        const icon = document.createElement('div');
        icon.className = 'plan-icon';
        icon.textContent = 'PDF';
        const meta = document.createElement('div');
        meta.className = 'plan-meta';
        meta.innerHTML = `<strong>${plan.name}</strong><small>${plan.desc || ''}</small>`;

        left.appendChild(icon);
        left.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'plan-actions';
        const openBtn = document.createElement('button');
        openBtn.textContent = 'Ouvrir';
        openBtn.onclick = ()=> openPDF(plan.file);

        const dlBtn = document.createElement('button');
        dlBtn.textContent = 'T√©l√©charger';
        dlBtn.onclick = ()=> downloadPDF(plan.file);

        actions.appendChild(openBtn);
        actions.appendChild(dlBtn);

        item.appendChild(left);
        item.appendChild(actions);

        plansList.appendChild(item);
      });
    }

    /* ===============
       R√©solution et t√©l√©chargement des PDF - m√©thode fiable
       - resolvePDF: encode correctement les chemins et g√®re URL compl√®tes
       - openPDF: ouvre dans un nouvel onglet (fallback simple)
       - downloadPDF: fetch -> blob -> download (force le download si possible)
       - downloadAll: lance les t√©l√©chargements s√©quentiels avec petit d√©lai
       ===============*/

    function resolvePDF(path) {
      if (!path) return '';
      // si c'est une URL compl√®te, encode et retourne
      if (/^https?:\/\//i.test(path)) return encodeURI(path);

      // sinon, on suppose fichier local dans le m√™me dossier que l'index.html
      // encodeURI pour g√©rer espaces et caract√®res sp√©ciaux
      return encodeURI(path);
      // Si tu pr√©f√®res utiliser GitHub Pages absolu, remplace par :
      // return `https://betdelest.github.io/Boubekri_Redouane/${encodeURI(path)}`;
    }

    function openPDF(path) {
      const final = resolvePDF(path);
      try {
        window.open(final, '_blank');
      } catch (err) {
        console.error('openPDF error', err);
        alert('Impossible d‚Äôouvrir le PDF directement. V√©rifie l‚ÄôURL.');
      }
    }

    async function downloadPDF(path) {
      const final = resolvePDF(path);
      try {
        const resp = await fetch(final, { method: 'GET', mode: 'cors' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const blob = await resp.blob();

        // Extraire un nom correct
        let filename = 'document.pdf';
        const cd = resp.headers.get('Content-Disposition');
        if (cd) {
          const m = /filename\*?=([^;]+)/i.exec(cd);
          if (m && m[1]) filename = m[1].replace(/['"]/g, '');
        } else {
          const parts = final.split('/');
          filename = parts[parts.length - 1] || filename;
        }
        filename = decodeURIComponent(filename).replace(/%20/g, '_');

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.warn('downloadPDF fallback (open in new tab) - reason:', err);
        // fallback : ouvrir dans un nouvel onglet, l'utilisateur pourra ensuite sauvegarder
        window.open(final, '_blank');
      }
    }

    function downloadAll() {
      const delay = 600; // ms entre chaque t√©l√©chargement pour r√©duire blocage popup
      PLANS.forEach((plan, idx) => {
        setTimeout(()=> downloadPDF(plan.file), idx * delay);
      });
    }

  </script>

</body>
</html>
